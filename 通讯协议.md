
### 概要
  * 考虑到在Modbus协议上使用，以及小嵌入式系统中的资源限制，采用此协议
  * 使用Modbus通讯协议，RTU模式，功能码由应用层指定。
  * Modbus协议一帧数据最长建议<=255，但FLASH的扇区组织一般以256字节为单位
  * 故扩展为：一帧数据最大长度(256 + 16) = 272字节。
  * 若使用其它协议(考虑到TCP等协议的不分拆包的情况下<1500)，
    则可将数据扩展为最多一帧数据1024(数据区长度=0，数据长>1024)
  
### 相关说明
  * 此协议依赖于"资源包描述"，以获取类型ID及其对应幻数(2Byte)，扇区分区等信息
  * 以下“错误码” 为8位无符号数，0正确，负错误，正其它信息。

### 1 握手协议之BOOT区操作
此协议用于通过app端更新boot区程序用。
#### 1.1 建立普通连接：
* 写入： 地址 + 功能码 + 子功能码0x12ED + 32位UID码 + CRC16校验 
* 返回： 地址 + 功能码 + 子功能码0x12ED +  错误码 + CRC16校验
* 注：写入的UID码让用户在设备上获得，特别地，当为0时，需让用户在设备上同意建立连接。 
#### 1.2 建立加密连接：
* 写入： 地址 + 功能码 + 子功能码0x21DE + CRC16校验 
* 返回： 地址 + 功能码 + 子功能码0x21DE +  错误码 + CRC16校验
* 注：加密连接的加密方式应约定，建议同UID或随机码关联以使数据唯一。
#### 1.3 断开连接并重启设备：
* 写入： 地址 + 功能码 + 子功能码0xaa55 + 写入的文件名 + CRC16校验 
* 返回： 若已握手，则写入程序完备信息，因设备重启了，故无返回。
         若未握手，则返回: 地址 + 功能码 + 子功能码0x21DE +  错误码-1 + CRC16校验
* 写入端可重复发送此指令，若返回未握手，则表示成功。
### 2 握手协议之普通数据区操作
此协议用于通过boot端更新用户区程序及相关资源用。
#### 2.1 建立更新普通数据区普通连接
  同“1.1建立更新BOOT区普通连接”，子功能码改为：0x34CB
  若已在boot状态,则返回错误码为0，若在app状态，则返回错误码为1, 并自动进入boot状态。
#### 2.2 建立更新BOOT区加密连接：
  同“1.2建立更新BOOT区加密连接”，子功能码改为：0x43BC。
#### 2.3 断开连接并重启设备：
  同“1.3断开连接并重启设备”

### 3 写Flash协议
#### 3.1 小数据分段写入协议(可选支持，boot区基本程序不连续时需支持)：
此协议用于一次性写入多个临近区域的离散数据，格式为：
* 写入：
  + 地址 + 功能码 + 子功能码0xa55a(加密时0xa5a5) + 类型ID + 对应幻数(2Byte) + 分段数 + 
  + 段0基址(2Byte) + 段0长度(1Byte)...段n基址 + 段n长度...
  + 数据区长度/4(1Byte) + 数据区Adler32校验码 + CRC16校验;
* 返回：
  + 地址 + 功能码 + 子功能码0xa55a + 错误码 + 32位已写入FLASH的数据Adler32校验码 + CRC16校验; 

#### 3.2 大数据多帧写入协议
此协议用于将一个大数据，分成多帧数据写入，格式为：
* 写入：
  + 地址 + 功能码 + 子功能码0x5aa5(加密时0x5a5a) + 类型ID + 对应幻数(2Byte) + 
  + 数据区长度/4(1Byte) + 数据帧顺序(2Byte)+ 数据区(<=256字节) + 
  + 数据区Adler32校验码 + CRC16校验;
* 返回：
  + 地址 + 功能码 + 子功能码0x5aa5 + 错误码 + 数据区Adler32校验码 + CRC16校验; 

### 3.3 FLASH扇区校验协议
*   此协议用于在不回读FLASH数据情况下，校验扇区的正确性。
* 写入：
  + 地址 + 功能码 + 子功能码0x55aa + 类型ID + 对应幻数(2Byte) + 
  + 校验码个数 + 扇区起始(2Byte) +
  + 扇区Adler32校验码数组 + CRC16校验;
* 返回：
  + 地址 + 功能码 + 子功能码0x55aa + 错误码 + CRC16校验; 
  + 错误码定义：0正确, 正：扇区错误(相对扇区起始)位置，负：数据异常

### 3.4 FLASH扇区内部数据块校验协议
*   此协议用于在不回读FLASH数据情况下，进一步校验扇区内（以256为单位）数据块正确性。
* 写入：
  + 地址 + 功能码 + 子功能码0x5fa0 + 类型ID + 对应幻数(2Byte) + 
  + 校验码个数 + 数据帧顺序(2Byte) +
  + 扇区Adler32校验码数组 + CRC16校验;
* 返回：
  + 地址 + 功能码 + 子功能码0x5fa0 + 错误码 + CRC16校验; 
  + 错误码定义：0正确, 正：数据块错误(相对数据帧顺序)位置，负：数据异常

